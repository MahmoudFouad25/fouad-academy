<!-- أضف هذا الكود في نهاية ملف index.html قبل إغلاق </body> -->

<!-- Firebase Configuration and Initialization -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
        getAuth, 
        signInWithPopup, 
        GoogleAuthProvider, 
        signOut, 
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc, 
        updateDoc,
        collection,
        getDocs,
        query,
        where,
        orderBy,
        addDoc,
        deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBAcPzPzIDYHvezf5klAwFzU0gmoo_AsCo",
        authDomain: "fouad-academy.firebaseapp.com",
        projectId: "fouad-academy",
        storageBucket: "fouad-academy.firebasestorage.app",
        messagingSenderId: "553738647199",
        appId: "1:553738647199:web:4e73c59b115da5be15d4aa",
        measurementId: "G-M0VML1SRZ4"
    };

    // Initialize Firebase
    let app, auth, db, storage;
    
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        
        // تصدير Firebase للنطاق العام
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        
        // تصدير الوظائف للاستخدام في auth.js
        window.firebaseAuthFunctions = {
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            updateProfile
        };
        
        window.firebaseFirestoreFunctions = {
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            getDocs,
            query,
            where,
            orderBy,
            addDoc,
            deleteDoc
        };
        
        window.firebaseStorageFunctions = {
            ref,
            uploadBytes,
            getDownloadURL
        };
        
        console.log('🔥 Firebase تم تحميله وتهيئته بنجاح!');
        
        // إشعار المستخدم بنجاح التحميل
        setTimeout(() => {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: #10b981;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                font-size: 0.8rem;
                z-index: 9999;
                animation: fadeInOut 3s ease;
            `;
            indicator.textContent = '🔥 Firebase متصل';
            
            const fadeAnimation = document.createElement('style');
            fadeAnimation.textContent = `
                @keyframes fadeInOut {
                    0%, 100% { opacity: 0; }
                    20%, 80% { opacity: 1; }
                }
            `;
            document.head.appendChild(fadeAnimation);
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 3000);
        }, 1000);
        
    } catch (error) {
        console.error('❌ خطأ في تحميل Firebase:', error);
        
        // إشعار بفشل Firebase
        setTimeout(() => {
            const errorIndicator = document.createElement('div');
            errorIndicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: #ef4444;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                font-size: 0.8rem;
                z-index: 9999;
            `;
            errorIndicator.textContent = '⚠️ Firebase غير متصل';
            document.body.appendChild(errorIndicator);
            
            setTimeout(() => errorIndicator.remove(), 5000);
        }, 1000);
    }
    
    // مراقبة حالة الاتصال
    window.addEventListener('online', () => {
        console.log('🌐 تم استعادة الاتصال بالإنترنت');
    });
    
    window.addEventListener('offline', () => {
        console.log('📡 فقدان الاتصال بالإنترنت');
    });

</script>

<!-- تحميل ملفات JavaScript بالترتيب الصحيح -->
<script src="shared/js/main.js"></script>
<script src="shared/js/auth.js"></script>

<!-- إضافة معالج لضمان تحميل auth.js بعد Firebase -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // التأكد من تحميل Firebase قبل تشغيل auth.js
    function checkFirebaseReady() {
        if (window.firebaseApp && window.firebaseAuth && window.firebaseDb) {
            console.log('✅ Firebase جاهز - تشغيل نظام المصادقة');
            
            // إعادة تهيئة نظام المصادقة إذا لزم الأمر
            if (window.fouadAuth && typeof window.fouadAuth.init === 'function') {
                // النظام محمل بالفعل
                console.log('🔄 نظام المصادقة محمل ومجهز');
            }
        } else {
            console.log('⏳ انتظار تحميل Firebase...');
            setTimeout(checkFirebaseReady, 100);
        }
    }
    
    // بدء فحص Firebase
    setTimeout(checkFirebaseReady, 500);
    
    // إضافة معالج للأخطاء العامة
    window.addEventListener('error', function(event) {
        console.error('خطأ في التطبيق:', event.error);
    });
    
    // معالج للوعود المرفوضة
    window.addEventListener('unhandledrejection', function(event) {
        console.error('وعد مرفوض:', event.reason);
    });
});
</script>
